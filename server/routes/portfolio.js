// routes/portfolio.js - –î–ª—è –±–µ—Å–ø–æ—â–∞–¥–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –≤–∞—à–∏—Ö –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã—Ö "–¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π"
const express = require('express');
const router = express.Router();
const Portfolio = require('../models/Portfolio');
const OpenAI = require('openai');

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ OpenAI
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
});

// –ü—Ä–æ—Å—Ç–æ–π –∫—ç—à –¥–ª—è –∞–Ω–∞–ª–∏–∑–æ–≤ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π
const portfolioCache = new Map();

// –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ä—Ç—Ñ–µ–ª—å (AKA –ø–æ—Å–º–µ—è—Ç—å—Å—è –Ω–∞–¥ –≤–∞—à–∏–º–∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è–º–∏)
router.post('/analyze', async (req, res) => {
  try {
    console.log('üìä –ö—Ç–æ-—Ç–æ –æ—Ç–≤–∞–∂–∏–ª—Å—è –ø–æ–∫–∞–∑–∞—Ç—å –Ω–∞–º —Å–≤–æ–π –ø–æ—Ä—Ç—Ñ–µ–ª—å. –°–º–µ–ª—ã–π —Ö–æ–¥!');
    const { portfolio } = req.body;
    
    if (!portfolio || !Array.isArray(portfolio) || portfolio.length === 0) {
      console.log('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–ª–∞–ª –ø—É—Å—Ç–æ–π –ø–æ—Ä—Ç—Ñ–µ–ª—å. –ú–æ–∂–µ—Ç, —ç—Ç–æ –∏ –∫ –ª—É—á—à–µ–º—É...');
      return res.status(400).json({ 
        message: 'Valid portfolio data is required',
        advice: '–ï—Å–ª–∏ —É –≤–∞—Å –Ω–µ—Ç –∫—Ä–∏–ø—Ç–æ–∞–∫—Ç–∏–≤–æ–≤, –ø–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã, –≤–æ–∑–º–æ–∂–Ω–æ, —É–º–Ω–µ–µ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –Ω–∞—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.'
      });
    }

    // –°–æ–∑–¥–∞–µ–º –∫–ª—é—á –∫—ç—à–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è
    const cacheKey = JSON.stringify(portfolio);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à (–∫–∞–∫ —Ç–≤–æ–π –ø–æ—Ä—Ç—Ñ–µ–ª—å - —Å –Ω–∞–¥–µ–∂–¥–æ–π –Ω–∞ —á—É–¥–æ)
    if (portfolioCache.has(cacheKey)) {
      console.log(`üß† –ù–∞—à–ª–∏ –∞–Ω–∞–ª–∏–∑ –≤ –∫—ç—à–µ! –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –æ—à–∏–±–∫–∏ —Å–ª–∏—à–∫–æ–º –æ—á–µ–≤–∏–¥–Ω—ã, —á—Ç–æ–±—ã –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –¥–≤–∞–∂–¥—ã.`);
      return res.json(portfolioCache.get(cacheKey));
    }
    
    console.log(`üí∞ –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ—Ä—Ç—Ñ–µ–ª—å –∏–∑ ${portfolio.length} –∫—Ä–∏–ø—Ç–æ–∞–∫—Ç–∏–≤–æ–≤. –î–æ—Å—Ç–∞–Ω—å—Ç–µ –ø–æ–ø–∫–æ—Ä–Ω!`);
    
    // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º—Ç –¥–ª—è OpenAI
    const prompt = `
      –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–π –∫—Ä–∏–ø—Ç–æ–ø–æ—Ä—Ç—Ñ–µ–ª—å —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —è–∑–≤–∏—Ç–µ–ª—å–Ω—ã–º –∏ —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–º —Ç–æ–Ω–æ–º:
      ${JSON.stringify(portfolio)}
      
      –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
      1. –°–æ–∑–¥–∞–π –±–µ—Å–ø–æ—â–∞–¥–Ω—ã–π —è–∑–≤–∏—Ç–µ–ª—å–Ω—ã–π "—Ä–∞–∑–±–æ—Ä" –ø–æ—Ä—Ç—Ñ–µ–ª—è –≤ —Ü–µ–ª–æ–º
      2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ —Å–æ–∑–¥–∞–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –Ω–∞—Å–º–µ—à–∫—É
      3. –û–ø–∏—à–∏ "–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é –≤—Å–µ–ª–µ–Ω–Ω—É—é", –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–Ω—è–ª –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è
      4. –ò—Å–ø–æ–ª—å–∑—É–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ–∫—Å–∏—á–Ω—ã–π, –Ω–æ —é–º–æ—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Ç–æ–Ω
      5. –í–∫–ª—é—á–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Ç–∞—Ñ–æ—Ä —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –∫—Ä–∞—Ö–∞
      
      –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ JSON:
      {
        "overallRoast": "–û–±—â–∏–π –∞–Ω–∞–ª–∏–∑ –ø–æ—Ä—Ç—Ñ–µ–ª—è –Ω–∞ 1-2 –∞–±–∑–∞—Ü–∞",
        "tokenAnalysis": [
          {
            "name": "–Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞",
            "roast": "–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –Ω–∞—Å–º–µ—à–∫–∞ –Ω–∞–¥ –≤—ã–±–æ—Ä–æ–º"
          },
          ...
        ],
        "alternateUniverse": "–û–ø–∏—Å–∞–Ω–∏–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–π –≤—Å–µ–ª–µ–Ω–Ω–æ–π, –≥–¥–µ –≤—ã–±–æ—Ä—ã –±—ã–ª–∏ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã–º–∏"
      }
    `;
    
    const response = await openai.chat.completions.create({
      model: "gpt-3.5-turbo",
      messages: [
        { role: "system", content: "–¢—ã - —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π, —è–∑–≤–∏—Ç–µ–ª—å–Ω—ã–π –ò–ò-–∞–Ω–∞–ª–∏—Ç–∏–∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ –∂–µ—Å—Ç–∫–∏–µ, –Ω–æ —Å–º–µ—à–Ω—ã–µ –∞–Ω–∞–ª–∏–∑—ã –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π." },
        { role: "user", content: prompt }
      ],
      temperature: 0.9,
      response_format: { type: "json_object" }
    });
    
    const analysis = JSON.parse(response.choices[0].message.content);
    console.log('üî• –ê–Ω–∞–ª–∏–∑ –≥–æ—Ç–æ–≤! –ù–∞–¥–µ–µ–º—Å—è, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–º–µ–µ—Ç —Å–º–µ—è—Ç—å—Å—è –Ω–∞–¥ —Å–æ–±–æ–π.');
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–Ω–∞–ª–∏–∑ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (–ø–æ—Ç–æ–º—É —á—Ç–æ —á—É–∂–∏–µ –æ—à–∏–±–∫–∏ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏)
    const newPortfolioAnalysis = new Portfolio({
      portfolio: portfolio,
      overallRoast: analysis.overallRoast,
      tokenAnalysis: analysis.tokenAnalysis,
      alternateUniverse: analysis.alternateUniverse
    });
    
    await newPortfolioAnalysis.save();
    console.log('üíæ –ê–Ω–∞–ª–∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö. –û–Ω —Ç–µ–ø–µ—Ä—å —á–∞—Å—Ç—å –Ω–∞—à–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ "–ö–∞–∫ –Ω–µ –Ω–∞–¥–æ –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å".');
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à (–ø–æ—Ä—Ç—Ñ–µ–ª–∏ —Ä–µ–¥–∫–æ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –ª—É—á—à–µ —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º)
    portfolioCache.set(cacheKey, analysis);
    
    res.json(analysis);
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω –Ω–∞—Å—Ç–æ–ª—å–∫–æ –ø–ª–æ—Ö, —á—Ç–æ —Å–ª–æ–º–∞–ª –Ω–∞—à –ò–ò:', error);
    
    // –ó–∞–ø–∞—Å–Ω–æ–π –∞–Ω–∞–ª–∏–∑, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
    const backupAnalysis = {
      overallRoast: "–ü–æ–∑–¥—Ä–∞–≤–ª—è—é! –¢–≤–æ–π –ø–æ—Ä—Ç—Ñ–µ–ª—å –Ω–∞—Å—Ç–æ–ª—å–∫–æ —É–Ω–∏–∫–∞–ª–µ–Ω, —á—Ç–æ –¥–∞–∂–µ –Ω–∞—à –ò–ò –æ—Ç–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –µ–≥–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å. –≠—Ç–æ –ª–∏–±–æ –≥–µ–Ω–∏–∞–ª—å–Ω–æ, –ª–∏–±–æ –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∏—á–Ω–æ - –Ω–æ, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –≤—Ç–æ—Ä–æ–µ. –°–æ—á–µ—Ç–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫, –±—É–¥—Ç–æ —Ç—ã –ø—Ä–æ—Å—Ç–æ —Å–ª–µ–¥–æ–≤–∞–ª —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º —Å–ª—É—á–∞–π–Ω—ã—Ö –ª—é–¥–µ–π –∏–∑ Telegram-–≥—Ä—É–ø–ø, –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –¥–æ–±–∞–≤–ª—è—è –≤—Å—ë, —á—Ç–æ –ø–æ—è–≤–ª—è–ª–æ—Å—å –≤ —Ç—Ä–µ–Ω–¥–∞—Ö Twitter.",
      tokenAnalysis: portfolio.map(item => ({
        name: item.token || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω",
        roast: `–ê—Ö, ${item.token || "—ç—Ç–æ—Ç —Ç–∞–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω"}. –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä —Ç–µ—Ö, –∫—Ç–æ –ª—é–±–∏—Ç —É—á–∏—Ç—å—Å—è –Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö. –ü–æ–∫—É–ø–∫–∞ –ø–æ $${item.buyPrice || "????"} –±—ã–ª–∞ –æ—Å–æ–±–µ–Ω–Ω–æ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–µ–π. –ù–∞–ø–æ–º–∏–Ω–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –æ —Ç–æ–º, –∫–∞–∫ –ø–æ–∫—É–ø–∞—Ç—å –Ω–∞ –ø–∏–∫–µ –∏ –¥–µ—Ä–∂–∞—Ç—å –¥–æ –Ω—É–ª—è.`
      })),
      alternateUniverse: "–í –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–π –≤—Å–µ–ª–µ–Ω–Ω–æ–π —Ç—ã –ø—Ä–æ—Å—Ç–æ –ø–æ–ª–æ–∂–∏–ª –≤—Å–µ —ç—Ç–∏ –¥–µ–Ω—å–≥–∏ –ø–æ–¥ –º–∞—Ç—Ä–∞—Å –∏ –ø–æ—Ç–µ—Ä—è–ª –±—ã —Ç–æ–ª—å–∫–æ –Ω–∞ –∏–Ω—Ñ–ª—è—Ü–∏–∏. –ò–ª–∏, –µ—â–µ –ª—É—á—à–µ, —Ç—ã –≤–ª–æ–∂–∏–ª—Å—è –≤ –∏–Ω–¥–µ–∫—Å–Ω—ã–π —Ñ–æ–Ω–¥ –∏ —Å–µ–π—á–∞—Å —Å–ø–æ–∫–æ–π–Ω–æ –ø—å–µ—à—å –∫–æ–∫—Ç–µ–π–ª—å –Ω–∞ –ø–ª—è–∂–µ, –≤–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–ª—è—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç, –Ω–∞–¥–µ—è—Å—å, —á—Ç–æ —Ç–≤–æ–π –ª—é–±–∏–º—ã–π —à–∏—Ç–∫–æ–∏–Ω –≤—ã—Ä–∞—Å—Ç–µ—Ç –Ω–∞ 10000%."
    };
    
    res.status(500).json({ 
      message: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –≤–∞—à–µ–≥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω —Å–ª–∏—à–∫–æ–º —É–Ω–∏–∫–∞–ª–µ–Ω (—á–∏—Ç–∞–π: —É–∂–∞—Å–µ–Ω).',
      analysis: backupAnalysis,
      error: process.env.NODE_ENV === 'development' ? error.message : 'Internal Server Error'
    });
  }
});

// –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∞–Ω–∞–ª–∏–∑–æ–≤ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π (–ø–æ—Ç–æ–º—É —á—Ç–æ –ª—é–¥–∏ —Ä–µ–¥–∫–æ —É—á–∞—Ç—Å—è –Ω–∞ —Å–≤–æ–∏—Ö –æ—à–∏–±–∫–∞—Ö)
router.get('/history', async (req, res) => {
  try {
    console.log('üèõÔ∏è –ö—Ç–æ-—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è –∏—Å—Ç–æ—Ä–∏–µ–π –∞–Ω–∞–ª–∏–∑–æ–≤. –ê—Ä—Ö–µ–æ–ª–æ–≥–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ?');
    const history = await Portfolio.find()
      .sort({ createdAt: -1 })
      .limit(10);
    
    console.log(`‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ${history.length} –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –∞–Ω–∞–ª–∏–∑–æ–≤. –ù–∞–¥–µ–µ–º—Å—è, –æ–Ω–∏ –ø–æ—Å–ª—É–∂–∞—Ç —É—Ä–æ–∫–æ–º (–Ω–æ –º—ã –∑–Ω–∞–µ–º, —á—Ç–æ –Ω–µ—Ç).`);
    res.json(history);
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ –∞–Ω–∞–ª–∏–∑–æ–≤. –ü—Ä–æ—à–ª–æ–µ —Ç–∞–∫ –∂–µ –Ω–µ–Ω–∞–¥–µ–∂–Ω–æ, –∫–∞–∫ –∏ –±—É–¥—É—â–µ–µ:', error);
    res.status(500).json({ 
      message: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∞–Ω–∞–ª–∏–∑–æ–≤. –ú–æ–∂–µ—Ç, —ç—Ç–æ –∏ –∫ –ª—É—á—à–µ–º—É.',
      error: process.env.NODE_ENV === 'development' ? error.message : 'Internal Server Error'
    });
  }
});

module.exports = router;